<!DOCTYPE html>
<html>
  <head>
    <!-- <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/ > -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
    

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>



    <style>

      /*#chartdiv {
        width: 100%;
        height: 600px;
      }*/

      body { background-color: #30303d; color: #fff; }

      #mapid { 
        height: 75vh; 
        width: 100%;
        position: center;
      }

     /* .ticks {
        font-size: 20px;
        fill: #fff;
        stroke: #fff;

      }*/
      .ticks line{
        stroke: white;
      }

      .ticks text{
        fill: white;
        font-size: 10px;
      }

      .track,
      .track-inset,
      .track-overlay {
        stroke-linecap: round;

      }

      .track {
        stroke: #000;
        stroke-opacity: 0.3;
        stroke-width: 10px;
      }

      .track-inset {
        stroke: #dcdcdc;
        stroke-width: 8px;
      }

      .track-overlay {
        pointer-events: stroke;
        stroke-width: 50px;
        stroke: transparent;
        cursor: crosshair;

      }

      .handle {
        fill: #fff;
        stroke: #000;
        stroke-opacity: 0.5;
        stroke-width: 1.25px;
      }

    </style>
  
  </head>
  <body>

    <nav class="navbar navbar-inverse">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">WPI IQP Data</a>
        </div>
        <ul class="nav navbar-nav">
          <li><a href="index.html">Sponsors</a></li>
          <li><a href="climateChange.html">Climate Change</a></li>
          <li><a href="points.html">points</a></li>
          <li class="active"><a href="WIN.html">WIN</a></li>
        </ul>
      </div>
    </nav>

    <div class="col-sm-8" id="chartdiv">
      <div id="mapid"></div>
    </div>
    <div class="col-sm-4" id="timeline">
      
    </div>
    

    <br>
    <br>

    <div class="col-sm-12">
      <h1 id="sponsorTitle" style="text-align: center;">Click on a country to find out about past IQP sponsors</h1>
    </div>

    <div class="col-sm-12" id="sponsorList">

    </div>
    
    
    <script src="lodash.js"></script>
    <script>

      projectCenters = {

        "Worcester Community Project Center": [41.2626, -70.8023],
        "Namibia": [-22.9576, 18.4904],
        "Puerto Rico": [18.2208, -66.5901],
        "Bar Harbor, Maine": [44.3876, -68.2039],
        "Microsoft Corporation": [0, 0],
        "Ifrane, Morocco": [33.5228, -5.1110],
        "WORC / Worcester Community Project Center": [43.2626, -72.8023],
        "Wuhan, China": [30.5928, 114.3055],
        "Lille, France": [50.6292, 3.0573],
        "Pioneer Valley Econ Dev": [10, 10],
        "Shanghai, China": [31.2304, 121.4737],




        "": [70, 0],
        "On-Campus": [70,0],
        "Asuncion, Paraguay": [-25.2637, -57.5759],
        "Bangkok, Thailand": [13.7563, 100.5018],
        "Boston, Massachusetts": [42.3601, -71.0589],
        "British Virgin Islands": [18.4207, -64.6400],
        "Campinas, Brazil": [-22.9329, -47.0738],
        "Cape Town, South Africa": [-33.9249, 18.4241],
        "Cuenca, Ecuador": [-2.9001, -79.0059],
        "London, England": [51.5074, -0.1278],
        "Mandi, India": [31.5892, 76.9182],
        "Melbourne, Australia": [-37.8136, 144.9631],
        "Rabat, Morocco": [33.9716, -6.8498],
        "San Jose, Costa Rica": [9.9281, -84.0907],
        "Thessaloniki, Greece": [40.6401, 22.9444],
        "Tirana, Albania": [41.3275, 19.8187],
        "Worcester Community Project Center (Massachusetts) - IQP": [70, 20],
        "Yerevan, Armenia": [40.1872, 44.5152],
        "Zurich, Switzerland": [47.3769, 8.5417]
      }
      

      var mymap = L.map('mapid').setView([30, 10], 2);

      var popup = L.popup();

      var markerLayers = {};
    
      var currentCountry;

      

      var sponsorInfo = {};
      var filteredInfo = {};



      d3.csv("WINProjects.csv", function(data) {
        console.log(data);
        
        data.forEach(function(info){

          if(sponsorInfo[info.ProjectCenter]){
            sponsorInfo[info.ProjectCenter][0].data.push({"title": info.Title, "center": info.ProjectCenter, "sponsor": info.Sponsor, "date": info.Date, "URL": info.Link});
          }
          else{
            sponsorInfo[info.ProjectCenter] = [{"data": [{"title": info.Title, "center": info.ProjectCenter, "sponsor": info.Sponsor, "date": info.Date, "URL": info.Link}], "location": projectCenters[info.ProjectCenter]}];
          }

          
        })

        console.log(sponsorInfo)

        filteredInfo = _.cloneDeep(sponsorInfo);

        createMap();
        
      });



      function createMap(){
        

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
          attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
          maxZoom: 18,
          id: 'mapbox.streets-satellite',
          accessToken: 'pk.eyJ1IjoiamFzb25hYmVsMTIzIiwiYSI6ImNqenNubWRnbDFibTQzbm1pOTNxbTIxemoifQ.9BZFzS-MQts7O6aGIoEqTw'
        }).addTo(mymap);


        Object.keys(filteredInfo).forEach(function(key) {
          // console.log(key, filteredInfo[key]);

          marker = L.marker(filteredInfo[key][0].location).addTo(mymap).bindPopup(key);

          marker.on('mouseover', showPopup);
          marker.on('mouseout', hidePopup);
          marker.on('click', function clickedPopup(e,){
            this.openPopup();
            currentCountry = key
            updateTable(key, filteredInfo[key][0].data);
          });

          var markerL = new L.FeatureGroup();
          markerL.addLayer(marker)

          markerLayers[key] = markerL
         
        })


      }

      function showPopup(){
        this.openPopup();
      }

      function hidePopup(){
        this.closePopup();
      }

      



      function updateTable(country, WINCenterInfo){

        var title = document.getElementById("sponsorTitle");
        title.innerHTML = "WIN projects in " + country;


        var tableRef = document.getElementById("sponsorList");
        tableRef.innerHTML = "";

        console.log(WINCenterInfo)

        var centerTitle = document.createElement("H3");
        centerTitle.setAttribute('style', 'text-align: center');
        centerTitle.innerHTML = country;
        tableRef.appendChild(centerTitle)

        var table = document.createElement("TABLE");
        table.setAttribute('class', 'table');
        tableRef.appendChild(table)


        var header = table.createTHead();
        var row = header.insertRow(0);
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        cell1.innerHTML = "<b>Title</b>";
        cell2.innerHTML = "<b>Sponsor</b>";
        cell3.innerHTML = "<b>Link</b>";


        console.log(WINCenterInfo)



        for(var i = 0; i < WINCenterInfo.length; i+=1){
          
          // Insert a row at the end of the table
          var newRow = table.insertRow(-1);

          // Insert a cell in the row at index 0
          var newCell1 = newRow.insertCell(0);
          var newCell2 = newRow.insertCell(1);
          var newCell3 = newRow.insertCell(2);

          // Append a text node to the cell

          var aTag = document.createElement("A");


          if(WINCenterInfo[i].title == null){
            var newText1 = document.createTextNode("");
          }
          else{
            var newText1 = document.createTextNode(WINCenterInfo[i].title);
          }

          if(WINCenterInfo[i].sponsor == null){
            var newText2 = document.createTextNode("");
          }
          else{
            var newText2 = document.createTextNode(WINCenterInfo[i].sponsor);
          }

          if(WINCenterInfo[i].URL == null){
            var newText3 = document.createTextNode("");
          }
          else{
            var newText3 = document.createTextNode(WINCenterInfo[i].URL);

            aTag.setAttribute('href', WINCenterInfo[i].URL);
            aTag.setAttribute('target', "_blank");
          }


          newCell1.appendChild(newText1);
          newCell2.appendChild(newText2);

          aTag.appendChild(newText3);
          newCell3.appendChild(aTag);
        }
      }
      
    </script>
    <script src="slider.js"></script>
    
  </body>
</html>